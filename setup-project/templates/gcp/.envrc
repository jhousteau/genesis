# GCP Per-Repository Isolation Configuration
# This file ensures this repository uses its own isolated gcloud configuration

# Project-specific variables
export PROJECT_ID="${PROJECT_ID}"
export REGION="${REGION:-us-central1}"
export ENVIRONMENT="${ENVIRONMENT:-dev}"

# Repository-local gcloud configuration directory
# Each repository gets its own isolated config to prevent cross-contamination
export REPO_GCLOUD_HOME="$HOME/.gcloud/${PROJECT_ID}-${ENVIRONMENT}"
export CLOUDSDK_CONFIG="${REPO_GCLOUD_HOME}"

# Set active configuration name
export CLOUDSDK_ACTIVE_CONFIG_NAME="default"

# Optional: Service account impersonation (recommended over local keys)
# Uncomment and set your service account:
# export DEPLOY_SA="deploy-${ENVIRONMENT}@${PROJECT_ID}.iam.gserviceaccount.com"
# export GCLOUD_IMPERSONATE_SA="${DEPLOY_SA}"

# Optional: Application Default Credentials (if needed by client libraries)
# Keep credentials repository-local to prevent cross-project access
# export GOOGLE_APPLICATION_CREDENTIALS="$PWD/.secrets/${PROJECT_ID}-adc.json"

# Production safety mechanism
if [[ "${PROJECT_ID}" =~ (^|-)prod(-|$) ]]; then
    echo "‚ö†Ô∏è  WARNING: Production project detected: ${PROJECT_ID}"
    echo "Set CONFIRM_PROD=I_UNDERSTAND to enable production operations"
    # export CONFIRM_PROD="I_UNDERSTAND"  # Uncomment only when needed
fi

# Terraform variables (if using Terraform)
export TF_VAR_project_id="${PROJECT_ID}"
export TF_VAR_region="${REGION}"
export TF_VAR_environment="${ENVIRONMENT}"

# Docker/Container Registry
export DOCKER_REGISTRY="${REGION}-docker.pkg.dev"
export DOCKER_REPO="${DOCKER_REGISTRY}/${PROJECT_ID}/containers"

# Logging configuration
export LOG_LEVEL="${LOG_LEVEL:-info}"
export STRUCTURED_LOGGING="true"

# Development tools
export ENABLE_HOT_RELOAD="${ENABLE_HOT_RELOAD:-true}"
export ENABLE_DEBUG="${ENABLE_DEBUG:-false}"

# Path modifications (add project scripts to PATH)
export PATH="$PWD/scripts:$PATH"

# Python virtual environment (if applicable)
if [[ -d ".venv" ]]; then
    source .venv/bin/activate
fi

# Node.js local binaries (if applicable)
if [[ -d "node_modules/.bin" ]]; then
    export PATH="$PWD/node_modules/.bin:$PATH"
fi

# Validation on directory entry
if [[ -f "scripts/bootstrap_gcloud.sh" ]] && [[ ! -d "${REPO_GCLOUD_HOME}" ]]; then
    echo "üîí First time setup detected. Running GCP isolation bootstrap..."
    ./scripts/bootstrap_gcloud.sh
fi

# Show current context
echo "üìÅ Project: ${PROJECT_ID}"
echo "üåç Region: ${REGION}"
echo "üîß Environment: ${ENVIRONMENT}"
echo "üîí Config: ${CLOUDSDK_CONFIG}"
